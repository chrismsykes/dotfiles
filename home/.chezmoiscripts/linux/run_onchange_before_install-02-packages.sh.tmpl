{{ if eq .osid "linux-debian" "linux-raspbian" "linux-ubuntu" -}}

{{ $packages := list
     "bat"
     "build-essential"
     "curl"
     "fd-find"
     "git"
     "git-lfs"
     "jq"
     "libfuse2"
     "luarocks"
     "npm"
     "openssh-server"
     "pip"
     "python3-venv"
     "ripgrep"
     "shellcheck"
     "units"
     "zsh" -}}

{{ $snaps := list -}}
{{ $classicSnaps := list -}}

{{ if eq .osid "linux-ubuntu" -}}
{{   $packages = mustAppend $packages "btop" -}}
{{ end -}}

{{ if not .headless -}}
{{   $packages = mustAppend $packages "xclip" -}}
{{   $classicSnaps = mustAppend $classicSnaps "code" -}}
{{ end -}}

{{ if .personal -}}
{{   $packages = mustAppend $packages "musl-tools" -}}
{{   $classicSnaps = concat $classicSnaps (list "goreleaser" "snapcraft") -}}
{{ end -}}

{{ $sudo := "sudo " -}}
{{ if eq .chezmoi.username "root" -}}
{{   $sudo = "" -}}
{{ end -}}

#!/bin/bash

set -eufo pipefail

# Define color codes
GREEN='\033[0;32m'
NC='\033[0m' # No Color

# Spinner function
spinner() {
  local pid=$1
  local delay=0.1
  local spinstr='|/-\'
  while [ "$(ps a | awk '{print $1}' | grep $pid)" ]; do
    local temp=${spinstr#?}
    printf " [%c]  " "$spinstr"
    spinstr=$temp${spinstr%"$temp"}
    sleep $delay
    printf "\b\b\b\b\b\b"
  done
  printf "    \b\b\b\b"
}

# Install packages with minimal output and spinner
echo -e "${GREEN}Pulling packages from package manager using default repos.${NC}"
echo -e "${GREEN}Updating apt...${NC}"
{{ $sudo }}apt-get update > /dev/null &
spinner $!
echo -e "${GREEN}Installing packages...${NC}"
{{ $sudo }}apt-get install -y {{ $packages | join " " }} > /dev/null &
spinner $!
echo -e "${GREEN}Packages installed successfully.${NC}"

{{ if lookPath "snap" }}
{{   range $snaps }}
echo -e "${GREEN}Checking and installing snap package: {{ . }}...${NC}"
( snap info {{ . }} | grep -q ^installed: ) || {{ $sudo }}snap install {{ . }}
{{   end }}
{{   range $classicSnaps }}
echo -e "${GREEN}Checking and installing classic snap package: {{ . }}...${NC}"
( snap info {{ . }} | grep -q ^installed: ) || {{ $sudo }}snap install --classic {{ . }}
{{   end }}
{{ end }}

{{ end -}}

{{ if .personal -}}
#!/bin/sh

set -eufo pipefail

# Ensure BW_SESSION is set
if [ -z "$BW_SESSION" ]; then
  echo "BW_SESSION is not set. Please set your Bitwarden session environment variable."
  exit 1
fi

# Fetch the private key from Bitwarden
private_key=$(bw get item domainlogin --raw --session "$BW_SESSION" | jq -r '.fields[] | select(.name == "privatekey") | .value')

# Check if the private key was fetched successfully
if [ -z "$private_key" ]; then
  echo "Failed to fetch the private key from Bitwarden."
  exit 1
fi

# Ensure the .ssh directory exists
mkdir -p ~/.ssh

# Write the private key to the id_rsa file if it doesn't already exist
if [ ! -f ~/.ssh/id_rsa ]; then
  echo "$private_key" > ~/.ssh/id_rsa
  chmod 600 ~/.ssh/id_rsa
  echo "Private key successfully written to ~/.ssh/id_rsa"
else
  echo "Private key already exists at ~/.ssh/id_rsa"
fi
{{ end -}}
